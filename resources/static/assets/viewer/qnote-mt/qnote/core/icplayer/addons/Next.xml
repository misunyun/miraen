<?xml version="1.0" encoding="UTF-8" standalone="no"?><addon xmlns="http://icplayer.com" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" id="Next" xsi:schemaLocation="http://icplayer.com ../../tools/addon.xsd">
	<model>
        <property isLocalized="true" name="Text" nameLabel="Next_property_text" type="string"/>
	</model>
<css>.next-wrapper,&#13;
.next-wrapper .next-container,&#13;
.next-wrapper .next-container .next-button {&#13;
    width: 100%;&#13;
    height: 100%;&#13;
}&#13;
&#13;
.next-wrapper .next-container .next-button {&#13;
    background: url('resources/next-button.png') no-repeat center;&#13;
    cursor: pointer;&#13;
    text-align: center;&#13;
}&#13;
&#13;
.next-wrapper.disabled .next-container .next-button {&#13;
    cursor: not-allowed;&#13;
    background: url('resources/next-button-disabled.png') no-repeat center;&#13;
}&#13;
</css><view>&lt;div class="next-wrapper"&gt;&#13;
    &lt;div class="next-container"&gt;&#13;
        &lt;div class="next-button"&gt;&#13;
&#13;
        &lt;/div&gt;&#13;
    &lt;/div&gt;&#13;
&lt;/div&gt;&#13;
</view><preview>&lt;div class="next-wrapper"&gt;&#13;
    &lt;div class="next-container"&gt;&#13;
        &lt;div class="next-button"&gt;&#13;
&#13;
        &lt;/div&gt;&#13;
    &lt;/div&gt;&#13;
&lt;/div&gt;&#13;
</preview><presenter>function AddonNext_create(){&#13;
&#13;
    var presenter = function(){};&#13;
&#13;
    presenter.playerController = null;&#13;
    presenter.eventBus = null;&#13;
    presenter.wasSubmitted = false;&#13;
&#13;
    presenter.setPlayerController = function (controller) {&#13;
        presenter.playerController = controller;&#13;
        presenter.eventBus = controller.getEventBus();&#13;
        presenter.eventBus.addEventListener('PageLoaded', this);&#13;
        presenter.eventBus.addEventListener('Submitted', this);&#13;
    };&#13;
&#13;
    presenter.onEventReceived = function(eventName) {&#13;
        if (eventName == 'PageLoaded') {&#13;
            presenter.pageLoadedDeferred.resolve();&#13;
        } else if (eventName == 'Submitted') {&#13;
            presenter.pageSubmittedDeferred.resolve();&#13;
        }&#13;
    };&#13;
&#13;
    presenter.createEventData = function (additionalEventData) {&#13;
        var eventData = { 'source': presenter.configuration.addonID };&#13;
        for (var key in additionalEventData) {&#13;
            eventData[key] = additionalEventData[key];&#13;
        }&#13;
        return eventData;&#13;
    };&#13;
&#13;
    presenter.sendEvent = function(eventName, eventData) {&#13;
        presenter.eventBus.sendEvent(eventName, eventData);&#13;
    };&#13;
&#13;
    presenter.ERROR_CODES = {&#13;
&#13;
    };&#13;
&#13;
    presenter.createPreview = function(view, model) {&#13;
        runLogic(view, model, true);&#13;
    };&#13;
&#13;
    presenter.validateModel = function(model, isPreview) {&#13;
        var buttonText = model['Text'];&#13;
&#13;
        return {&#13;
            'buttonText' : buttonText,&#13;
            'addonID' : model['ID']&#13;
        }&#13;
    };&#13;
&#13;
    function getAllOfTheModulesThatImplementIsAttempted() {&#13;
        var pageIndex = presenter.playerController.getCurrentPageIndex(),&#13;
            ids = presenter.playerController.getPresentation().getPage(pageIndex).getModulesAsJS(),&#13;
            modules = [];&#13;
&#13;
        $.each(ids, function() {&#13;
            var id = this.toString(),&#13;
                currentModule = presenter.playerController.getModule(id);&#13;
&#13;
            if (currentModule &amp;&amp; currentModule.isAttempted !== undefined) {&#13;
                modules.push(currentModule);&#13;
            }&#13;
&#13;
        });&#13;
&#13;
        return modules;&#13;
    }&#13;
&#13;
    function areAllModulesAttempted() {&#13;
        var areAllAttempted = true;&#13;
&#13;
        $.each(presenter.modulesOnPage, function() {&#13;
            if (!this.isAttempted()) {&#13;
                areAllAttempted = false;&#13;
                return false; // break;&#13;
            }&#13;
        });&#13;
&#13;
        return areAllAttempted;&#13;
    }&#13;
&#13;
    presenter.goToNextPage = function() {&#13;
        var pageIndex = presenter.playerController.getCurrentPageIndex();&#13;
        if (pageIndex + 1 &lt; presenter.playerController.getPresentation().getPageCount()) {&#13;
            presenter.playerController.getCommands().gotoPageIndex(pageIndex + 1);&#13;
        }&#13;
    };&#13;
&#13;
    function runLogic(view, model, isPreview) {&#13;
        presenter.pageLoadedDeferred = new $.Deferred();&#13;
        presenter.pageLoaded = presenter.pageLoadedDeferred.promise();&#13;
        presenter.pageSubmittedDeferred = new $.Deferred();&#13;
        presenter.pageSubmitted = presenter.pageSubmittedDeferred.promise();&#13;
        presenter.runEndedDeferred = new $.Deferred();&#13;
        presenter.runEnded = presenter.runEndedDeferred.promise();&#13;
&#13;
        presenter.configuration = presenter.validateModel(model, isPreview);&#13;
&#13;
        if (presenter.configuration.isError) {&#13;
            DOMOperationsUtils.showErrorMessage(view, presenter.ERROR_CODES, presenter.configuration.errorCode);&#13;
            return;&#13;
        }&#13;
&#13;
        presenter.$view = $(view);&#13;
        presenter.submitButton = presenter.$view.find('.next-button');&#13;
        presenter.submitButton.html(presenter.configuration.buttonText);&#13;
        presenter.nextWrapper = presenter.$view.find('.next-wrapper');&#13;
        presenter.nextWrapper.addClass('disabled');&#13;
&#13;
        presenter.pageSubmitted.then(function() {&#13;
            presenter.nextWrapper.removeClass('disabled');&#13;
        });&#13;
&#13;
        presenter.pageLoaded.then(function() {&#13;
&#13;
            presenter.modulesOnPage = getAllOfTheModulesThatImplementIsAttempted();&#13;
&#13;
            presenter.submitButton.click(function(e) {&#13;
                e.stopPropagation();&#13;
&#13;
                if (presenter.nextWrapper.hasClass('disabled')) {&#13;
&#13;
                    if (areAllModulesAttempted()) {&#13;
&#13;
                        presenter.sendEvent('AllAttempted', presenter.createEventData());&#13;
&#13;
                    } else {&#13;
&#13;
                        presenter.sendEvent('NotAllAttempted', presenter.createEventData());&#13;
&#13;
                    }&#13;
&#13;
                } else {&#13;
&#13;
                    presenter.wasSubmitted = true;&#13;
                    presenter.goToNextPage();&#13;
&#13;
                }&#13;
&#13;
            });&#13;
&#13;
            presenter.runEndedDeferred.resolve();&#13;
        });&#13;
&#13;
    }&#13;
&#13;
    presenter.run = function(view, model){&#13;
        runLogic(view, model, false);&#13;
    };&#13;
&#13;
    presenter.setShowErrorsMode = function(){&#13;
    };&#13;
&#13;
    presenter.setWorkMode = function(){&#13;
    };&#13;
&#13;
    presenter.reset = function(){&#13;
    };&#13;
&#13;
    presenter.getErrorCount = function(){&#13;
        return 0;&#13;
    };&#13;
&#13;
    presenter.getMaxScore = function(){&#13;
        return 0;&#13;
    };&#13;
&#13;
    presenter.getScore = function(){&#13;
        return 0;&#13;
    };&#13;
&#13;
    presenter.getState = function(){&#13;
        return JSON.stringify({&#13;
            'wasSubmitted' : presenter.wasSubmitted&#13;
        });&#13;
    };&#13;
&#13;
    presenter.setState = function(state){&#13;
        var parsed = JSON.parse(state);&#13;
&#13;
        presenter.wasSubmitted = parsed.wasSubmitted;&#13;
&#13;
        presenter.runEnded.then(function() {&#13;
            if (parsed.wasSubmitted) {&#13;
                presenter.nextWrapper.removeClass('disabled');&#13;
            }&#13;
        });&#13;
    };&#13;
&#13;
    return presenter;&#13;
}&#13;
</presenter></addon>